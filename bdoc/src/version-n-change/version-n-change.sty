% == PACKAGES == %

\RequirePackage{marginnote}


% == TOOLS == %

% -- CHANGE LOG - VERSION & NEW -- %

\reversemarginpar{}

\ExplSyntaxOn

%%%
% The list ``\l_bdoc_date_parts_seq``, the strings ``\l_bdoc_date_year_str``,
% ``\l_bdoc_date_month_str`` and ``\l_bdoc_date_day_str`` are used to obtain
% the good formatting of dates regarding to the language wanted.
%%%
\seq_new:N \l_bdoc_date_parts_seq

\str_new:N \l_bdoc_date_year_str
\str_new:N \l_bdoc_date_month_str
\str_new:N \l_bdoc_date_day_str


%%%
% prototype::
%     #1 : a date YYYY-MM-DD
%
%     :action: this macro set the string values of ``\l_bdoc_date_year_str``,
%              ``\l_bdoc_date_month_str`` and ``\l_bdoc_date_day_str`` using
%              a basic parsing of the date argument.
%%%
\NewDocumentCommand{ \l_bdoc_good_date } { m } {
    \seq_set_split:Nnn \l_bdoc_date_parts_seq { - } { #1 }
    \seq_pop:NN \l_bdoc_date_parts_seq \l_bdoc_date_year_str
    \seq_pop:NN \l_bdoc_date_parts_seq \l_bdoc_date_month_str
    \seq_pop:NN \l_bdoc_date_parts_seq \l_bdoc_date_day_str
}


%%%
% prototype::
%     #1 : a color
%     #2 : the first material (a date)
%     #3 : the second material (a version number)
%     #4 : the last negative vertical spacing
%
%     :action: this macro factorizes the printing of the changes in
%              the left margin.
%%%
\NewDocumentCommand{ \l_bdoc_new_change_margin } { m m m m } {
    \marginnote{
        \color{#1}
        \scriptsize
        \centering
        \vspace{0pt}
        \rule{1.65cm}{.95pt}
        \vspace{-2.9pt}

        \par
            \l_bdoc_good_date{ #2 }

            \bdoc@trans@date{\l_bdoc_date_year_str}
                            {\l_bdoc_date_month_str}
                            {\l_bdoc_date_day_str}
        \par

        \vspace{1pt}

        \par
            #3
        \par

        \vspace{#4}
        \rule{1.65cm}{.95pt}
    }[-.345cm]
}


%%%
% prototype::
%     #1 : a color
%     #2 : a version number
%     #3 : a date YYYY-MM-DD
%
%     :action: this macro prints a margin note showing a version number
%              upon a date, and the optional argument is used to colorized
%              all this text.
%
% warning::
%     The date must use the english formatting like ``2021-07-14``. This allows
%     to parse the date such as to display it following the standard convention
%     of the language chosen when loading the package.
%
% note::
%     The version number must look like ``maj.min.bug`` or
%     ``maj.min.bug-extra`` with three integers ``maj``, ``min``, ``bug``
%     and an optional ``extra`` equal to ``alpha``, ``beta`` or ``rc``
%     for "release candidate".
%%%
\NewDocumentCommand{ \bdocversion } { O{blue} m m } {
    \l_bdoc_new_change_margin { #1 }      % Color
                              { #3 }      % Date
                              { #2 }      % Version
                              { -6.25pt } % Last negative vertical spacing
}


%%%
% prototype::
%     #1 : a color
%     #2 : a date YYYY-MM-DD
%
%     :action: this macro is similar to ``\bdocversion`` except that it just
%              prints a date.
%%%
\NewDocumentCommand{ \bdocdate } { O{blue} m } {
    \l_bdoc_new_change_margin { #1 }      % Color
                              { #2 }      % Date
                              {}          % Version
                              { -5.35pt } % Last negative spacing
}



% -- CHANGE LOG - TOPIC -- %

%%%   ?????
%
%%%   ?????
\msg_set:nnnn { bdoc } { topic-missing-title }
    { Missing \ title. }
    { One \ single \ title \ must \ be \ indicated. }

%%%
% ?
%%%

\tl_new:N \l_bdoc_topic_title_tl

%%%   ?????
% prototype::
%     #1 : the title inside []
%     #2 : the title inside <>
%
%     :action: this environment prints some Â¨infos about specific changes
%              achieved in a new version (no special formatting is applied).
%
% The option allows two kinds of formatting. Here is what is available.
%
%     1) By default, ``i`` for "inline" asks to put the content just after
%        the title.
%
%     2) ``t`` for "title" asks to put the content in a new line below
%        the title.
%%%
\NewDocumentEnvironment{ bdoctopic }{O{} D<>{} }{
    \IfBlankT{#1#2}{
        \msg_fatal:nn { bdoc } { topic-missing-title }
    }

    \IfBlankTF{#1}{
        \tl_set:Nn \l_bdoc_topic_title_tl {#2}
    }{
        \tl_set:Nn \l_bdoc_topic_title_tl {#1}
    }

    \medskip

    \textbf{
        \textsc{\tl_use:N \l_bdoc_topic_title_tl}

        \IfBlankTF{#1}{
            .
        }{
            \bdoc@colon{}
        }
    }%
}{}

\ExplSyntaxOff
