% == PACKAGES == %

\RequirePackage{marginnote}[2023-09-07]


% == TOOLS == %

% -- CHANGES - FOCUS IT --%

\ExplSyntaxOn

% :: MESSAGES :: %

\msg_set:nnnn { bdoc } { date-bad-nb-of-minus }
  { Illegal ~ date ~ with ~ a ~ bad ~ number ~ of ~ minus. }
  { Use ~ the ~ format ~ YYYY-MM-DD. }

% \msg_set:nnnn { bdoc } { date-not-in-calendar }
%   { Date ~ not ~ in ~ the ~ calendar. }
%   { }


% :: DATE LIKE TYPE :: %

%%%
% We used well-named variables to obtain the good formatting of dates
% regarding to the language wanted.
%%%
\str_new:N \l_bdoc_date_year_str
\str_new:N \l_bdoc_date_month_str
\str_new:N \l_bdoc_date_day_str


%%%
% prototype::
%     #1 : a date in the format ``YYYY-MM-DD``
%
%     :action: this macro set the string values of ``\l_bdoc_date_year_str``,
%              ``\l_bdoc_date_month_str`` and ``\l_bdoc_date_day_str`` without
%              checking the vailidity of the date ``#1''.
%%%
\NewDocumentCommand{\bdoc@set@date@vars}{m}{
% Do we have 3 parts?
  \seq_set_split:Nnn \l_tmpa_seq { - } { #1 }

  \int_set:Nn \l_tmpa_int
              {\int_eval:n {\seq_count:N \l_tmpa_seq}}

  \if_int_compare:w \l_tmpa_int = 3
  \else:
    \msg_error:nn { bdoc } { date-bad-nb-of-minus }
  \fi:

% Let's get the 3 parts of the date.
  \seq_pop:NN \l_tmpa_seq \l_bdoc_date_year_str
  \seq_pop:NN \l_tmpa_seq \l_bdoc_date_month_str
  \seq_pop:NN \l_tmpa_seq \l_bdoc_date_day_str
}


% :: MARGIN NOTE :: %

\reversemarginpar{}

%%%
% prototype::
%     #1 : the color of the margin note
%     #2 : the first material (a date)
%     #3 : the second material (a version number)
%     #4 : the last negative vertical spacing for the 2nd rule
%
%     :action: this macro factorizes the printing of the changes in
%              the left margin.
%%%
\NewDocumentCommand{\bdoc@new@change@margin}{m m m m}{
  \marginnote{
    \color{#1}
    \scriptsize
    \centering

    \vspace{0pt}
    \rule{1.65cm}{.95pt}
    \vspace{-2.9pt}

    \par
      \bdoc@set@date@vars{#2}

      \bdoc@trans@date{\l_bdoc_date_year_str}
                      {\l_bdoc_date_month_str}
                      {\l_bdoc_date_day_str}
    \par

    \vspace{1pt}

    \par
      #3
    \par

    \vspace{#4}
    \rule{1.65cm}{.95pt}
  }[-.345cm]
}


% :: VERSION AND DATE - NEWTHING :: %

%%%
% prototype::
%     #1 : the color of the margin note
%     #2 : a version number
%     #3 : a date ``YYYY-MM-DD``
%
%     :action: this macro prints a margin note showing a version number
%              upon a date, and the optional argument is used to colorized
%              all this text.
%
% warning::
%     The date must use the english formatting like ``2021-07-14``. This allows
%     to parse the date such as to display it following the standard convention
%     of the language chosen when loading the package.
%
% note::
%     The version number must look like ``maj.min.bug`` or
%     ``maj.min.bug-extra`` with three integers ``maj``, ``min``, ``bug``
%     and an optional ``extra`` equal to ``alpha``, ``beta`` or ``rc``
%     for "release candidate".
%%%
\NewDocumentCommand{\bdocversion}{O{blue} m m}{
  \bdoc@new@change@margin{#1}      % Color
                         {#3}      % Date
                         {#2}      % Version
                         {-6.25pt} % Last negative vertical spacing
}


% :: DATE - NEWTHING :: %

%%%
% prototype::
%     #1 : the color of the margin note
%     #2 : a date ``YYYY-MM-DD``
%
%     :action: this macro is similar to ``\bdocversion`` except that it just
%              prints a date.
%%%
\NewDocumentCommand{\bdocdate}{O{blue} m}{
  \bdoc@new@change@margin{#1}      % Color
                         {#2}      % Date
                         {}        % Version
                         {-5.35pt} % Last negative spacing
}


% -- EXPLAIN SOMETHING NEW -- %

% :: MESSAGES :: %

\msg_set:nnnn { bdoc } { changes-topic-missing-title }
  { Missing ~ title. }
  { One ~ single ~ title ~ must ~ be ~ indicated. }


% :: TOPIC ENVIRONMENT :: %

\tl_new:N \l_bdoc_topic_title_tl

%%%
% prototype::
%     #1 : a title that will be followed by a colon.
%     #2 : a title that will be followed by a point.
%
%     :action: this environment prints some Â¨infos about specific changes
%              achieved in a new version (no special formatting is applied).
%
% warning::
%     Either ``#1`` or ``#2`` can be used.
%%%
\NewDocumentEnvironment{bdoctopic}{
  O{}
  D<>{}
}{
  \IfBlankT{#1#2}{
    \msg_fatal:nn { bdoc } { changes-topic-missing-title }
  }

  \IfBlankTF{#1}{
    \tl_set:Nn \l_bdoc_topic_title_tl {#2}
  }{
    \tl_set:Nn \l_bdoc_topic_title_tl {#1}
  }

  \medskip

  \textbf{
    \textsc{\tl_use:N \l_bdoc_topic_title_tl}

    \IfBlankTF{#1}{
      .
    }{
      \bdoc@colon{}
    }
  }%
}{}

\ExplSyntaxOff
